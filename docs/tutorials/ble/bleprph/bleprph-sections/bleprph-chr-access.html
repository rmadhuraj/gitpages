

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Characteristic Access &mdash; Apache Mynewt latest documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../../search.html"/>
      <link rel="top" title="Apache Mynewt latest documentation" href="../../../../index.html"/> 

    
    <script src="../../../../_static/js/modernizr.min.js"></script>

    
    <script>
    (function(i, s, o, g, r, a, m) {
	i["GoogleAnalyticsObject"] = r;
	(i[r] =
		i[r] ||
		function() {
			(i[r].q = i[r].q || []).push(arguments);
		}),
		(i[r].l = 1 * new Date());
	(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
	a.async = 1;
	a.src = g;
	m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.7.0, Apache NimBLE 1.2.0 </a> released (August 4, 2019)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/quick-start/">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/events/">Events</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Characteristic Access
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-documentation/edit/master/docs/tutorials/ble/bleprph/bleprph-sections/bleprph-chr-access.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    <!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
  <option value="/latest" selected>
    Version: latest
  </option>
  <option value="/v1_7_0" >
    Version: 1.7.0
  </option>
  <option value="/v1_6_0" >
    Version: 1.6.0
  </option>
  <option value="/v1_5_0" >
    Version: 1.5.0
  </option>
  <option value="/v1_4_0" >
    Version: 1.4.0
  </option>
  <option value="/v1_3_0/os/introduction" >
    Version: 1.3.0
  </option>
  <option value="/v1_2_0/os/introduction" >
    Version: 1.2.0
  </option>
  <option value="/v1_1_0/os/introduction" >
    Version: 1.1.0
  </option>
  <option value="/v1_0_0/os/introduction" >
    Version: 1.0.0
  </option>
  <option value="/v0_9_0/os/introduction" >
    Version: 0.9.0
  </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../decawave/decawave.html">Decawave-UWB User Guide</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              

              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="characteristic-access">
<h1>Characteristic Access<a class="headerlink" href="#characteristic-access" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#review" id="id1">Review</a></li>
<li><a class="reference internal" href="#function-signature" id="id2">Function signature</a></li>
<li><a class="reference internal" href="#determine-characteristic-being-accessed" id="id3">Determine characteristic being accessed</a></li>
<li><a class="reference internal" href="#read-access" id="id4">Read access</a></li>
<li><a class="reference internal" href="#write-access" id="id5">Write access</a></li>
</ul>
</div>
<div class="section" id="review">
<h2><a class="toc-backref" href="#id1">Review</a><a class="headerlink" href="#review" title="Permalink to this headline">¶</a></h2>
<p>A characteristic’s access callback implements its behavior. Recall that
services and characteristics are registered with NimBLE via attribute
tables. Each characteristic definition in an attribute table contains an
<em>access_cb</em> field. The <em>access_cb</em> field is an application callback
that gets executed whenever a peer device attempts to read or write the
characteristic.</p>
<p>Earlier in this tutorial, we looked at how <em>bleprph</em> implements the GAP
service. Let’s take another look at how <em>bleprph</em> specifies the first
few characteristics in this service.</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static const struct ble_gatt_svc_def gatt_svr_svcs[] = {
    {
        /*** Service: GAP. */
        .type               = BLE_GATT_SVC_TYPE_PRIMARY,
        .uuid128            = BLE_UUID16(BLE_GAP_SVC_UUID16),
        .characteristics    = (struct ble_gatt_chr_def[]) { {
            /*** Characteristic: Device Name. */
            .uuid128            = BLE_UUID16(BLE_GAP_CHR_UUID16_DEVICE_NAME),
            .access_cb          = gatt_svr_chr_access_gap,
            .flags              = BLE_GATT_CHR_F_READ,
        }, {
            /*** Characteristic: Appearance. */
            .uuid128            = BLE_UUID16(BLE_GAP_CHR_UUID16_APPEARANCE),
            .access_cb          = gatt_svr_chr_access_gap,
            .flags              = BLE_GATT_CHR_F_READ,
        }, {
    // [...]
</pre></div>
</div>
<p>As you can see, <em>bleprph</em> uses the same <em>access_cb</em> function for all
the GAP service characteristics, but the developer could have
implemented separate functions for each characteristic if they
preferred. Here is the <em>access_cb</em> function that the GAP service
characteristics use:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static int
gatt_svr_chr_access_gap(uint16_t conn_handle, uint16_t attr_handle, uint8_t op,
                        union ble_gatt_access_ctxt *ctxt, void *arg)
{
    uint16_t uuid16;

    uuid16 = ble_uuid_128_to_16(ctxt-&gt;chr_access.chr-&gt;uuid128);
    assert(uuid16 != 0);

    switch (uuid16) {
    case BLE_GAP_CHR_UUID16_DEVICE_NAME:
        assert(op == BLE_GATT_ACCESS_OP_READ_CHR);
        ctxt-&gt;chr_access.data = (void *)bleprph_device_name;
        ctxt-&gt;chr_access.len = strlen(bleprph_device_name);
        break;

    case BLE_GAP_CHR_UUID16_APPEARANCE:
        assert(op == BLE_GATT_ACCESS_OP_READ_CHR);
        ctxt-&gt;chr_access.data = (void *)&amp;bleprph_appearance;
        ctxt-&gt;chr_access.len = sizeof bleprph_appearance;
        break;

    case BLE_GAP_CHR_UUID16_PERIPH_PRIV_FLAG:
        assert(op == BLE_GATT_ACCESS_OP_READ_CHR);
        ctxt-&gt;chr_access.data = (void *)&amp;bleprph_privacy_flag;
        ctxt-&gt;chr_access.len = sizeof bleprph_privacy_flag;
        break;

    case BLE_GAP_CHR_UUID16_RECONNECT_ADDR:
        assert(op == BLE_GATT_ACCESS_OP_WRITE_CHR);
        if (ctxt-&gt;chr_access.len != sizeof bleprph_reconnect_addr) {
            return BLE_ATT_ERR_INVALID_ATTR_VALUE_LEN;
        }
        memcpy(bleprph_reconnect_addr, ctxt-&gt;chr_access.data,
               sizeof bleprph_reconnect_addr);
        break;

    case BLE_GAP_CHR_UUID16_PERIPH_PREF_CONN_PARAMS:
        assert(op == BLE_GATT_ACCESS_OP_READ_CHR);
        ctxt-&gt;chr_access.data = (void *)&amp;bleprph_pref_conn_params;
        ctxt-&gt;chr_access.len = sizeof bleprph_pref_conn_params;
        break;

    default:
        assert(0);
        break;
    }

    return 0;
}
</pre></div>
</div>
<p>After you’ve taken a moment to examine the structure of this function,
let’s explore some details.</p>
</div>
<div class="section" id="function-signature">
<h2><a class="toc-backref" href="#id2">Function signature</a><a class="headerlink" href="#function-signature" title="Permalink to this headline">¶</a></h2>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>static int
gatt_svr_chr_access_gap(uint16_t conn_handle, uint16_t attr_handle, uint8_t op,
                        union ble_gatt_access_ctxt *ctxt, void *arg)
</pre></div>
</div>
<p>A characteristic access function always takes this same set of
parameters and always returns an int. The parameters to this function
type are documented below.</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="33%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Parameter</strong></th>
<th class="head"><strong>Purpose</strong></th>
<th class="head"><strong>Notes</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>conn_handle</td>
<td>Indicates
which
connection
the
characterist
ic
access was
sent over.</td>
<td>Use this
value to
determine
which peer
is
accessing
the
characteri
stic.</td>
</tr>
<tr class="row-odd"><td>attr_handle</td>
<td>The
low-level
ATT handle
of the
characterist
ic
value
attribute.</td>
<td>Can be
used to
determine
which
characteri
stic
is being
accessed
if you
don’t want
to perform
a UUID
lookup.</td>
</tr>
<tr class="row-even"><td>op</td>
<td>Indicates
whether this
is a read or
write
operation</td>
<td>Valid
values
are:<em>BLE
_GATT_AC
CESS_OP_
READ_CHR</em>
<em>BLE_
GATT_ACCE
SS_OP_WR
ITE_CHR</em></td>
</tr>
<tr class="row-odd"><td>ctxt</td>
<td>Contains the
characterist
ic
value
pointer that
the
application
needs to
access.</td>
<td>For
characteri
stic
accesses,
use the
<em>ctxt-&gt;chr
_access</em>
member;
for
descriptor
accesses,
use the
<em>ctxt-&gt;dsc
_access</em>
member.</td>
</tr>
</tbody>
</table>
<p>The return value of the access function tells the NimBLE stack how to
respond to the peer performing the operation. A value of 0 indicates
success. For failures, the function returns the specific ATT error code
that the NimBLE stack should respond with. The ATT error codes are
defined in
<a class="reference external" href="https://github.com/apache/incubator-mynewt-core/blob/master/net/nimble/host/include/host/ble_att.h">net/nimble/host/include/host/ble_att.h</a>.</p>
</div>
<div class="section" id="determine-characteristic-being-accessed">
<h2><a class="toc-backref" href="#id3">Determine characteristic being accessed</a><a class="headerlink" href="#determine-characteristic-being-accessed" title="Permalink to this headline">¶</a></h2>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>{
    uint16_t uuid16;

    uuid16 = ble_uuid_128_to_16(ctxt-&gt;chr_access.chr-&gt;uuid128);
    assert(uuid16 != 0);

    switch (uuid16) {
        // [...]
</pre></div>
</div>
<p>This function uses the UUID to determine which characteristic is being
accessed. There are two alternative methods <em>bleprph</em> could have used to
accomplish this task:</p>
<ul class="simple">
<li>Map characteristics to ATT handles during service registration; use
the <em>attr_handle</em> parameter as a key into this table during
characteristic access.</li>
<li>Implement a dedicated function for each characteristic; each function
inherently knows which characteristic it corresponds to.</li>
</ul>
<p>All the GAP service characteristics have 16-bit UUIDs, so this function
uses the <em>ble_uuid_128_to_16()</em> function to convert the 128-bit UUID
to its corresponding 16-bit UUID. This conversion function returns the
corresponding 16-bit UUID on success, or 0 on failure. Success is
asserted here to ensure the NimBLE stack is doing its job properly; the
stack should only call this function for accesses to characteristics
that it is registered with, and all GAP service characteristics have
valid 16-bit UUIDs.</p>
</div>
<div class="section" id="read-access">
<h2><a class="toc-backref" href="#id4">Read access</a><a class="headerlink" href="#read-access" title="Permalink to this headline">¶</a></h2>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>case BLE_GAP_CHR_UUID16_DEVICE_NAME:
    assert(op == BLE_GATT_ACCESS_OP_READ_CHR);
    ctxt-&gt;chr_access.data = (void *)bleprph_device_name;
    ctxt-&gt;chr_access.len = strlen(bleprph_device_name);
    break;
</pre></div>
</div>
<p>This code excerpt handles read accesses to the device name
characteristic. The <em>assert()</em> here is another case of making sure the
NimBLE stack is doing its job; this characteristic was registered as
read-only, so the stack should have prevented write accesses.</p>
<p>To fulfill a characteristic read request, the application needs to
assign the <em>ctxt-&gt;chr_access.data</em> field to point to the attribute data
to respond with, and fill the <em>ctxt-&gt;chr_access.len</em> field with the
length of the attribute data. <em>bleprph</em> stores the device name in
read-only memory as follows:</p>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>const char *bleprph_device_name = &quot;nimble-bleprph&quot;;
</pre></div>
</div>
<p>The cast to pointer-to-void is a necessary annoyance to remove the
<em>const</em> qualifier from the device name variable. You will need to “cast
away const” whenever you respond to read requests with read-only data.</p>
<p>It is not shown in the above snippet, but this function ultimately
returns 0. By returning 0, <em>bleprph</em> indicates that the characteristic
data in <em>ctxt-&gt;chr_access</em> is valid and that NimBLE should include it
in its response to the peer.</p>
<p><strong>A word of warning:</strong> The attribute data that <em>ctxt-&gt;chr_access.data</em>
points to must remain valid after the access function returns, as the
NimBLE stack needs to use it to form a GATT read response. In other
words, you must not allocate the characteristic value data on the stack
of the access function. Two characteristic accesses never occur at the
same time, so it is OK to use the same memory for repeated accesses.</p>
</div>
<div class="section" id="write-access">
<h2><a class="toc-backref" href="#id5">Write access</a><a class="headerlink" href="#write-access" title="Permalink to this headline">¶</a></h2>
<div class="code c highlight-none notranslate"><div class="highlight"><pre><span></span>case BLE_GAP_CHR_UUID16_RECONNECT_ADDR:
    assert(op == BLE_GATT_ACCESS_OP_WRITE_CHR);
    if (ctxt-&gt;chr_access.len != sizeof bleprph_reconnect_addr) {
        return BLE_ATT_ERR_INVALID_ATTR_VALUE_LEN;
    }
    memcpy(bleprph_reconnect_addr, ctxt-&gt;chr_access.data,
           sizeof bleprph_reconnect_addr);
    break;
</pre></div>
</div>
<p>This code excerpt handles writes to the reconnect address
characteristic. This characteristic was registered as write-only, so the
<em>assert()</em> here is just a safety precaution to ensure the NimBLE stack
is doing its job.</p>
<p>For writes, the roles of the <em>ctxt-&gt;chr_access.data</em> and
<em>ctxt-&gt;chr_access.len</em> fields are the reverse of the read case. The
NimBLE stack uses these fields to indicate the data written by the peer.</p>
<p>Many characteristics have strict length requirements for write
operations. This characteristic has such a restriction; if the written
data is not a 48-bit BR address, the application tells NimBLE to respond
with an invalid attribute value length error.</p>
<p>For writes, the <em>ctxt-&gt;chr_access.data</em> pointer is only valid for the
duration of the access function. If the application needs to save the
written data, it should store it elsewhere before the function returns.
In this case, <em>bleprph</em> stores the specified address in a global
variable called <em>bleprph_reconnect_addr</em>.</p>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="">
                <img src="../../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'latest',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/language_data.js"></script>
      <script type="text/javascript" src="../../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../../_static/js/main.js"></script>

   

  </body>
</html>